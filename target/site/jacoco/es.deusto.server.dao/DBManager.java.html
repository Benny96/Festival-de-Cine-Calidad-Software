<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DBManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Festival_Cine</a> &gt; <a href="index.source.html" class="el_package">es.deusto.server.dao</a> &gt; <span class="el_source">DBManager.java</span></div><h1>DBManager.java</h1><pre class="source lang-java linenums">package es.deusto.server.dao;

import es.deusto.server.data.*;

import javax.jdo.*;
import java.util.ArrayList;

/**
 * Este bloque de c칩digo implementa la interfaz IDAO, y representa la implementaci칩n del patr칩n de dise침o DAO. Por lo
 * tanto, es la clase encargada de hacer procesos CRU (Create, Read, Update) con los datos de la base de datos MySQL,
 * gestionada a su vez mediante DataNucleus. No se ha necesitado de borrado de datos.
 * @author Grupo RMBJ
 * @version 3.0
 * @since 1.0
 */
public class DBManager implements IDAO {

	private PersistenceManagerFactory pmf;

<span class="nc" id="L20">	public DBManager() {</span>
<span class="nc" id="L21">		pmf = JDOHelper.getPersistenceManagerFactory(&quot;datanucleus.properties&quot;);</span>
<span class="nc" id="L22">	}</span>

	@Override
	public void storeUsuario(UsuarioDTO u) {

<span class="nc" id="L27">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L28">		Transaction tx = pm.currentTransaction();</span>
		try {
<span class="nc" id="L30">			tx.begin();</span>
<span class="nc" id="L31">			System.out.println(&quot;   * Storing a user: &quot; + u.getLogin());</span>
<span class="nc" id="L32">			pm.makePersistent(u);</span>
<span class="nc" id="L33">			tx.commit();</span>
<span class="nc" id="L34">		} catch (Exception ex) {</span>
<span class="nc" id="L35">			System.out.println(&quot;   $ Error storing an object: &quot; + ex.getMessage());</span>
		} finally {
<span class="nc bnc" id="L37" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L38">				tx.rollback();</span>
			}

<span class="nc" id="L41">			pm.close();</span>
		}
<span class="nc" id="L43">	}</span>

	@Override
	public UsuarioDTO retrieveUsuario(String login) {
<span class="nc" id="L47">		UsuarioDTO usuarioDTO = null;</span>
<span class="nc" id="L48">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L49">		pm.getFetchPlan().setMaxFetchDepth(2);</span>
<span class="nc" id="L50">		Transaction tx = pm.currentTransaction();</span>
		try {
<span class="nc" id="L52">			tx.begin();</span>
<span class="nc" id="L53">			usuarioDTO = pm.getObjectById(UsuarioDTO.class, login);</span>
<span class="nc" id="L54">			tx.commit();</span>
<span class="nc" id="L55">		} catch (JDOObjectNotFoundException jonfe) {</span>
<span class="nc" id="L56">			System.out.println(&quot;User does not exist: &quot; + jonfe.getMessage());</span>
		}

		finally {
<span class="nc bnc" id="L60" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L61">				tx.rollback();</span>
			}

<span class="nc" id="L64">			pm.close();</span>
		}

<span class="nc" id="L67">		return usuarioDTO;</span>
	}

	@Override
	public void updateUsuario(UsuarioDTO u) {
<span class="nc" id="L72">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L73">		Transaction tx = pm.currentTransaction();</span>

		try {
<span class="nc" id="L76">			tx.begin();</span>
<span class="nc" id="L77">			pm.makePersistent(u);</span>
<span class="nc" id="L78">			tx.commit();</span>
<span class="nc" id="L79">		} catch (Exception ex) {</span>
<span class="nc" id="L80">			System.out.println(&quot;Error updating a user: &quot; + ex.getMessage());</span>
		} finally {
<span class="nc bnc" id="L82" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L83">				tx.rollback();</span>
			}

<span class="nc" id="L86">			pm.close();</span>
		}

<span class="nc" id="L89">	}</span>

	@Override
	public void storeActor(ActorDTO a) {
<span class="nc" id="L93">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L94">		Transaction tx = pm.currentTransaction();</span>
		try {
<span class="nc" id="L96">			tx.begin();</span>
<span class="nc" id="L97">			System.out.println(&quot;   * Storing an actor: &quot; + a.getNombre() + &quot; &quot; + a.getApellido());</span>
<span class="nc" id="L98">			pm.makePersistent(a);</span>
<span class="nc" id="L99">			tx.commit();</span>
<span class="nc" id="L100">		} catch (Exception ex) {</span>
<span class="nc" id="L101">			System.out.println(&quot;   $ Error storing an object: &quot; + ex.getMessage());</span>
		} finally {
<span class="nc bnc" id="L103" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L104">				tx.rollback();</span>
			}

<span class="nc" id="L107">			pm.close();</span>
		}
<span class="nc" id="L109">	}</span>

	@Override
	public ActorDTO retrieveActor(String id) {
<span class="nc" id="L113">		ActorDTO actorDTO = null;</span>
<span class="nc" id="L114">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L115">		pm.getFetchPlan().setMaxFetchDepth(3);</span>
<span class="nc" id="L116">		Transaction tx = pm.currentTransaction();</span>
		try {
<span class="nc" id="L118">			tx.begin();</span>
<span class="nc" id="L119">			actorDTO = pm.getObjectById(ActorDTO.class, id);</span>
<span class="nc" id="L120">			tx.commit();</span>
<span class="nc" id="L121">		} catch (JDOObjectNotFoundException jonfe) {</span>
<span class="nc" id="L122">			System.out.println(&quot;Actor does not exist: &quot; + jonfe.getMessage());</span>
		}

		finally {
<span class="nc bnc" id="L126" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L127">				tx.rollback();</span>
			}

<span class="nc" id="L130">			pm.close();</span>
		}

<span class="nc" id="L133">		return actorDTO;</span>
	}

	@Override
	public void updateActor(ActorDTO a) {
<span class="nc" id="L138">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L139">		Transaction tx = pm.currentTransaction();</span>

		try {
<span class="nc" id="L142">			tx.begin();</span>
<span class="nc" id="L143">			pm.makePersistent(a);</span>
<span class="nc" id="L144">			tx.commit();</span>
<span class="nc" id="L145">		} catch (Exception ex) {</span>
<span class="nc" id="L146">			System.out.println(&quot;Error updating an actor: &quot; + ex.getMessage());</span>
		} finally {
<span class="nc bnc" id="L148" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L149">				tx.rollback();</span>
			}

<span class="nc" id="L152">			pm.close();</span>
		}
<span class="nc" id="L154">	}</span>

	@Override
	public ArrayList&lt;ActorDTO&gt; getActors() {
<span class="nc" id="L158">		ArrayList&lt;ActorDTO&gt; actors = new ArrayList&lt;ActorDTO&gt;();</span>
<span class="nc" id="L159">		PersistenceManager pm = null;</span>
<span class="nc" id="L160">		Transaction tx = null;</span>
		try
		{
<span class="nc" id="L163">			pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L164">			tx = pm.currentTransaction();</span>
<span class="nc" id="L165">			tx.begin();</span>
<span class="nc" id="L166">			Extent&lt;ActorDTO&gt; extent = pm.getExtent(ActorDTO.class, true);</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">			for (ActorDTO actor : extent)</span>
			{
<span class="nc" id="L170">				actors.add(actor);</span>
<span class="nc" id="L171">			}</span>
		}
<span class="nc" id="L173">		catch (Exception ex)</span>
		{
<span class="nc" id="L175">			System.err.println(&quot; $ Error retrieving actors using an 'Extent': &quot; + ex.getMessage());</span>
		}
		finally
		{
<span class="nc bnc" id="L179" title="All 4 branches missed.">			if (pm != null &amp;&amp; !pm.isClosed()) {</span>
<span class="nc" id="L180">				pm.close();</span>
			}
		}
<span class="nc" id="L183">		return actors;</span>
	}

	@Override
	public void storePelicula(PeliculaDTO p) {
<span class="nc" id="L188">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L189">		Transaction tx = pm.currentTransaction();</span>
		try {
<span class="nc" id="L191">			tx.begin();</span>
<span class="nc" id="L192">			System.out.println(&quot;   * Storing a pelicula: &quot; + p.getTitulo());</span>
<span class="nc" id="L193">			pm.makePersistent(p);</span>
<span class="nc" id="L194">			tx.commit();</span>
<span class="nc" id="L195">		} catch (Exception ex) {</span>
<span class="nc" id="L196">			System.out.println(&quot;   $ Error storing an object: &quot; + ex.getMessage());</span>
		} finally {
<span class="nc bnc" id="L198" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L199">				tx.rollback();</span>
			}

<span class="nc" id="L202">			pm.close();</span>
		}
<span class="nc" id="L204">	}</span>

	@Override
	public PeliculaDTO retrievePelicula(String titulo) {
<span class="nc" id="L208">		PeliculaDTO peliculaDTO = null;</span>
<span class="nc" id="L209">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L210">		pm.getFetchPlan().setMaxFetchDepth(3);</span>
<span class="nc" id="L211">		Transaction tx = pm.currentTransaction();</span>
		try {
<span class="nc" id="L213">			tx.begin();</span>
<span class="nc" id="L214">			peliculaDTO = pm.getObjectById(PeliculaDTO.class, titulo);</span>
<span class="nc" id="L215">			tx.commit();</span>
<span class="nc" id="L216">		} catch (JDOObjectNotFoundException jonfe) {</span>
<span class="nc" id="L217">			System.out.println(&quot;Pelicula does not exist: &quot; + jonfe.getMessage());</span>
		}

		finally {
<span class="nc bnc" id="L221" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L222">				tx.rollback();</span>
			}

<span class="nc" id="L225">			pm.close();</span>
		}

<span class="nc" id="L228">		return peliculaDTO;</span>
	}

	@Override
	public void updatePelicula(PeliculaDTO p) {
<span class="nc" id="L233">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L234">		Transaction tx = pm.currentTransaction();</span>

		try {
<span class="nc" id="L237">			tx.begin();</span>
<span class="nc" id="L238">			pm.makePersistent(p);</span>
<span class="nc" id="L239">			tx.commit();</span>
<span class="nc" id="L240">		} catch (Exception ex) {</span>
<span class="nc" id="L241">			System.out.println(&quot;Error updating a pelicula: &quot; + ex.getMessage());</span>
		} finally {
<span class="nc bnc" id="L243" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L244">				tx.rollback();</span>
			}

<span class="nc" id="L247">			pm.close();</span>
		}
<span class="nc" id="L249">	}</span>

	@Override
	public ArrayList&lt;PeliculaDTO&gt; getPeliculas() {
<span class="nc" id="L253">		ArrayList&lt;PeliculaDTO&gt; peliculas = new ArrayList&lt;PeliculaDTO&gt;();</span>
<span class="nc" id="L254">		PersistenceManager pm = null;</span>
<span class="nc" id="L255">		Transaction tx = null;</span>
		try
		{
<span class="nc" id="L258">			pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L259">			tx = pm.currentTransaction();</span>
<span class="nc" id="L260">			tx.begin();</span>
<span class="nc" id="L261">			Extent&lt;PeliculaDTO&gt; extent = pm.getExtent(PeliculaDTO.class, true);</span>

<span class="nc bnc" id="L263" title="All 2 branches missed.">			for (PeliculaDTO pelicula : extent)</span>
			{
<span class="nc" id="L265">				peliculas.add(pelicula);</span>
<span class="nc" id="L266">			}</span>
		}
<span class="nc" id="L268">		catch (Exception ex)</span>
		{
<span class="nc" id="L270">			System.err.println(&quot; $ Error retrieving peliculas using an 'Extent': &quot; + ex.getMessage());</span>
		}
		finally
		{
<span class="nc bnc" id="L274" title="All 4 branches missed.">			if (pm != null &amp;&amp; !pm.isClosed()) {</span>
<span class="nc" id="L275">				pm.close();</span>
			}
		}
<span class="nc" id="L278">		return peliculas;</span>
	}

	@Override
	public void storeValoracion(ValoracionDTO v) {
<span class="nc" id="L283">		PersistenceManager pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L284">		Transaction tx = pm.currentTransaction();</span>
		try {
<span class="nc" id="L286">			tx.begin();</span>
<span class="nc" id="L287">			System.out.println(&quot;   * Storing a valoracion: &quot; + v.getId());</span>
<span class="nc" id="L288">			pm.makePersistent(v);</span>
<span class="nc" id="L289">			tx.commit();</span>
<span class="nc" id="L290">		} catch (Exception ex) {</span>
<span class="nc" id="L291">			System.out.println(&quot;   $ Error storing an object: &quot; + ex.getMessage());</span>
		} finally {
<span class="nc bnc" id="L293" title="All 4 branches missed.">			if (tx != null &amp;&amp; tx.isActive()) {</span>
<span class="nc" id="L294">				tx.rollback();</span>
			}

<span class="nc" id="L297">			pm.close();</span>
		}
<span class="nc" id="L299">	}</span>

	@Override
	public ArrayList&lt;ValoracionDTO&gt; getValoraciones() {
<span class="nc" id="L303">		ArrayList&lt;ValoracionDTO&gt; valoraciones = new ArrayList&lt;ValoracionDTO&gt;();</span>
<span class="nc" id="L304">		PersistenceManager pm = null;</span>
<span class="nc" id="L305">		Transaction tx = null;</span>
		try
		{
<span class="nc" id="L308">			pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L309">			tx = pm.currentTransaction();</span>
<span class="nc" id="L310">			tx.begin();</span>
<span class="nc" id="L311">			Extent&lt;ValoracionDTO&gt; extent = pm.getExtent(ValoracionDTO.class, true);</span>

<span class="nc bnc" id="L313" title="All 2 branches missed.">			for (ValoracionDTO valoracion : extent)</span>
			{
<span class="nc" id="L315">				valoraciones.add(valoracion);</span>
<span class="nc" id="L316">			}</span>
		}
<span class="nc" id="L318">		catch (Exception ex)</span>
		{
<span class="nc" id="L320">			System.err.println(&quot; $ Error retrieving valoraciones using an 'Extent': &quot; + ex.getMessage());</span>
		}
		finally
		{
<span class="nc bnc" id="L324" title="All 4 branches missed.">			if (pm != null &amp;&amp; !pm.isClosed()) {</span>
<span class="nc" id="L325">				pm.close();</span>
			}
		}
<span class="nc" id="L328">		return valoraciones;</span>
	}

	@Override
	public ArrayList&lt;ComentarioDTO&gt; getComentarios() {
<span class="nc" id="L333">		ArrayList&lt;ComentarioDTO&gt; comentarios = new ArrayList&lt;ComentarioDTO&gt;();</span>
<span class="nc" id="L334">		PersistenceManager pm = null;</span>
<span class="nc" id="L335">		Transaction tx = null;</span>
		try
		{
<span class="nc" id="L338">			pm = pmf.getPersistenceManager();</span>
<span class="nc" id="L339">			tx = pm.currentTransaction();</span>
<span class="nc" id="L340">			tx.begin();</span>
<span class="nc" id="L341">			Extent&lt;ComentarioDTO&gt; extent = pm.getExtent(ComentarioDTO.class, true);</span>

<span class="nc bnc" id="L343" title="All 2 branches missed.">			for (ComentarioDTO comentario : extent)</span>
			{
<span class="nc" id="L345">				comentarios.add(comentario);</span>
<span class="nc" id="L346">			}</span>
		}
<span class="nc" id="L348">		catch (Exception ex)</span>
		{
<span class="nc" id="L350">			System.err.println(&quot; $ Error retrieving comentarios using an 'Extent': &quot; + ex.getMessage());</span>
		}
		finally
		{
<span class="nc bnc" id="L354" title="All 4 branches missed.">			if (pm != null &amp;&amp; !pm.isClosed()) {</span>
<span class="nc" id="L355">				pm.close();</span>
			}
		}
<span class="nc" id="L358">		return comentarios;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>